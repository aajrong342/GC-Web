<!-- Enhanced users.hbs -->
<div class="admin-container">
    <h2>Manage Users</h2>
    
    <div class="action-bar">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search by name, email, or role...">
            <button id="searchButton"><i class="fa-solid fa-search"></i></button>
        </div>
        <div class="filter-container">
            <select id="statusFilter">
                <option value="all">All Statuses</option>
                <option value="Unverified">Unverified</option>
                <option value="In Progress">In Progress</option>
                <option value="Verified">Verified</option>
            </select>
        </div>
        <div class="add-container">
            <button id="addUserButton" class="btn-add-user">
                <i class="fa-solid fa-user-plus"></i> Create New User
            </button>
        </div>
    </div>

    <div class="tb-container">
        <table id="usersTable">
            <tr class="tb-header"> <!-- Column Headers -->
                <td class="td-button-container"><!-- Blank column for user actions --></td>
                <td>User ID</td>
                <td>Role</td>
                <td>Full Name</td>
                <td>Email</td>
                <td>User Account Status</td>
                <td>Contact No.</td>
                <td>Last Login</td>
                <td>Successful Logins</td>
                <td>Failed Logins</td>
            </tr>
            <tr class="tb-gray-row">
                <td class="td-button-container">
                    <button class="tb-button-action edit" onclick="editUser(1)"><i class="fa-solid fa-pencil"></i></button>
                    <button class="tb-button-action delete" onclick="deleteUser(1)"><i class="fa-solid fa-trash"></i></button>
                </td>
                <td>1</td>
                <td>GreenCycle - Data Cleaner</td>
                <td>RAZON, Christine Joy</td>
                <td>ceidge.razon@greencycleconsultancy.com</td>
                <td><span class="status-badge verified">VERIFIED</span></td>
                <td>+63 (123) 456 7890</td>
                <td>Mar 5, 2025 10:45 AM</td>
                <td>23</td>
                <td>0</td>
            </tr>
            <tr>
                <td class="td-button-container">
                    <button class="tb-button-action edit" onclick="editUser(2)"><i class="fa-solid fa-pencil"></i></button>
                    <button class="tb-button-action delete" onclick="deleteUser(2)"><i class="fa-solid fa-trash"></i></button>
                </td>
                <td>2</td>
                <td>GreenCycle - Staff</td>
                <td>ALVAREZ, Maricon</td>
                <td>maricon.alvarez@greencycleconsultancy.com</td>
                <td><span class="status-badge verified">VERIFIED</span></td>
                <td>+63 (123) 456 7890</td>
                <td>Mar 6, 2025 9:30 AM</td>
                <td>15</td>
                <td>1</td>
            </tr>
            <tr class="tb-gray-row">
                <td class="td-button-container">
                    <button class="tb-button-action edit" onclick="editUser(3)"><i class="fa-solid fa-pencil"></i></button>
                    <button class="tb-button-action delete" onclick="deleteUser(3)"><i class="fa-solid fa-trash"></i></button>
                </td>
                <td>3</td>
                <td>Client - Standard</td>
                <td>REYES, Marco</td>
                <td>marco.reyes@example.com</td>
                <td><span class="status-badge unverified">UNVERIFIED</span></td>
                <td>+63 (234) 567 8901</td>
                <td>Never</td>
                <td>0</td>
                <td>0</td>
            </tr>
            <tr>
                <td class="td-button-container">
                    <button class="tb-button-action edit" onclick="editUser(4)"><i class="fa-solid fa-pencil"></i></button>
                    <button class="tb-button-action delete" onclick="deleteUser(4)"><i class="fa-solid fa-trash"></i></button>
                </td>
                <td>4</td>
                <td>Client - Premium</td>
                <td>SANTOS, Sofia</td>
                <td>sofia.santos@example.com</td>
                <td><span class="status-badge in-progress">IN PROGRESS</span></td>
                <td>+63 (345) 678 9012</td>
                <td>Mar 3, 2025 2:15 PM</td>
                <td>3</td>
                <td>0</td>
            </tr>
        </table>
    </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Edit User</h2>
        
        <form id="editUserForm">
            <input type="hidden" id="userId">
            
            <div class="form-group">
                <label for="editRole">Role:</label>
                <select id="editRole" name="roleId">
                    <option value="1">GreenCycle - Administrator</option>
                    <option value="2">GreenCycle - Staff</option>
                    <option value="3">GreenCycle - Data Cleaner</option>
                    <option value="4">Client - Standard</option>
                    <option value="5">Client - Premium</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editLastName">Last Name:</label>
                <input type="text" id="editLastName" name="lastName">
            </div>
            
            <div class="form-group">
                <label for="editFirstName">First Name:</label>
                <input type="text" id="editFirstName" name="firstName">
            </div>
            
            <div class="form-group">
                <label for="editEmail">Email:</label>
                <input type="email" id="editEmail" name="email">
                <div id="editEmailError" class="error-message hidden">
                    For staff accounts, email must be the GreenCycle organization email address (@greencycleconsultancy.com)
                </div>
            </div>
            
            <div class="form-group">
                <label for="editContactNo">Contact Number:</label>
                <input type="text" id="editContactNo" name="contactNo">
            </div>
            
            <div class="form-group">
                <label for="editStatus">Account Status:</label>
                <select id="editStatus" name="status">
                    <option value="Unverified">Unverified</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Verified">Verified</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editPassword">Reset Password (leave blank to keep current):</label>
                <input type="password" id="editPassword" name="password">
            </div>
            
            <div class="form-buttons">
                <button type="button" id="cancelEditButton" class="btn-cancel">Cancel</button>
                <button type="submit" id="saveUserButton" class="btn-submit">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content modal-small">
        <span class="close">&times;</span>
        <h2>Confirm Deletion</h2>
        <p>Are you sure you want to delete this user? This action cannot be undone.</p>
        <div class="user-to-delete">
            <strong id="deleteUserName">SANTOS, Sofia</strong>
            <span id="deleteUserEmail">sofia.santos@example.com</span>
        </div>
        <div class="form-buttons">
            <button id="cancelDeleteButton" class="btn-cancel">Cancel</button>
            <button id="confirmDeleteButton" class="btn-delete">Delete User</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add User button
    const addUserButton = document.getElementById('addUserButton');
    addUserButton.addEventListener('click', function() {
        window.location.href = '/dashboard/users/create';
    });
    
    // Search and filtering
    const searchButton = document.getElementById('searchButton');
    searchButton.addEventListener('click', function() {
        filterUsers();
    });
    
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            filterUsers();
        }
    });
    
    const statusFilter = document.getElementById('statusFilter');
    statusFilter.addEventListener('change', function() {
        filterUsers();
    });
    
    // Edit User Modal
    const editModal = document.getElementById('editUserModal');
    const editCloseBtn = editModal.getElementsByClassName('close')[0];
    const cancelEditBtn = document.getElementById('cancelEditButton');
    
    editCloseBtn.onclick = function() {
        editModal.style.display = "none";
    }
    
    cancelEditBtn.onclick = function() {
        editModal.style.display = "none";
    }
    
    // Delete Confirmation Modal
    const deleteModal = document.getElementById('deleteConfirmModal');
    const deleteCloseBtn = deleteModal.getElementsByClassName('close')[0];
    const cancelDeleteBtn = document.getElementById('cancelDeleteButton');
    
    deleteCloseBtn.onclick = function() {
        deleteModal.style.display = "none";
    }
    
    cancelDeleteBtn.onclick = function() {
        deleteModal.style.display = "none";
    }
    
    // Handle edit form submission
    const editUserForm = document.getElementById('editUserForm');
    editUserForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate staff email
        const roleId = document.getElementById('editRole').value;
        const email = document.getElementById('editEmail').value;
        const emailError = document.getElementById('editEmailError');
        
        if ((roleId === '1' || roleId === '2' || roleId === '3') && !email.includes('@greencycleconsultancy.com')) {
            emailError.classList.remove('hidden');
            return;
        }
        
        // Form data to send to server
        const userId = document.getElementById('userId').value;
        const formData = {
            roleId: document.getElementById('editRole').value,
            lastName: document.getElementById('editLastName').value,
            firstName: document.getElementById('editFirstName').value,
            email: email,
            contactNo: document.getElementById('editContactNo').value,
            status: document.getElementById('editStatus').value,
            password: document.getElementById('editPassword').value
        };
        
        // Send data to server (AJAX request)
        fetch(`/users/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok');
        })
        .then(data => {
            alert('User updated successfully!');
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating user. Please try again.');
        });
    });
    
    // Handle delete confirmation
    const confirmDeleteBtn = document.getElementById('confirmDeleteButton');
    confirmDeleteBtn.addEventListener('click', function() {
        const userId = confirmDeleteBtn.dataset.userId;
        
        // Send delete request to server
        fetch(`/users/${userId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                alert('User deleted successfully!');
                location.reload();
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting user. Please try again.');
        });
    });
    
    // Close modals when clicking outside
    window.onclick = function(event) {
        if (event.target == editModal) {
            editModal.style.display = "none";
        } else if (event.target == deleteModal) {
            deleteModal.style.display = "none";
        }
    }
});

// Filter users function
function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    
    const rows = document.querySelectorAll('#usersTable tr:not(.tb-header)');
    
    rows.forEach(row => {
        const role = row.cells[2].textContent.toLowerCase();
        const name = row.cells[3].textContent.toLowerCase();
        const email = row.cells[4].textContent.toLowerCase();
        const statusCell = row.cells[5].querySelector('.status-badge');
        const status = statusCell ? statusCell.textContent : '';
        
        const matchesSearch = role.includes(searchTerm) || name.includes(searchTerm) || 
                             email.includes(searchTerm) || searchTerm === '';
        const matchesStatus = statusFilter === 'all' || status.includes(statusFilter.toUpperCase());
        
        if (matchesSearch && matchesStatus) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Edit user function
function editUser(userId) {
    // This would typically fetch user data from server
    // For demo, we'll use data from the table
    const userTable = document.getElementById('usersTable');
    const rows = userTable.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) { // Skip header row
        const cells = rows[i].getElementsByTagName('td');
        const id = cells[1].textContent;
        
        if (id == userId) {
            // Populate form with user data
            document.getElementById('userId').value = userId;
            
            const role = cells[2].textContent;
            const roleSelect = document.getElementById('editRole');
            for (let j = 0; j < roleSelect.options.length; j++) {
                if (roleSelect.options[j].text === role) {
                    roleSelect.selectedIndex = j;
                    break;
                }
            }
            
            const fullName = cells[3].textContent;
            const nameParts = fullName.split(', ');
            document.getElementById('editLastName').value = nameParts[0];
            document.getElementById('editFirstName').value = nameParts[1] || '';
            
            document.getElementById('editEmail').value = cells[4].textContent;
            
            const status = cells[5].textContent;
            const statusSelect = document.getElementById('editStatus');
            for (let j = 0; j < statusSelect.options.length; j++) {
                if (statusSelect.options[j].text.toUpperCase() === status) {
                    statusSelect.selectedIndex = j;
                    break;
                }
            }
            
            document.getElementById('editContactNo').value = cells[6].textContent;
            document.getElementById('editPassword').value = '';
            
            // Clear any previous error messages
            document.getElementById('editEmailError').classList.add('hidden');
            
            // Show the modal
            document.getElementById('editUserModal').style.display = 'block';
            break;
        }
    }
}

// Delete user function
function deleteUser(userId) {
    // Get user details for confirmation
    const userTable = document.getElementById('usersTable');
    const rows = userTable.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) { // Skip header row
        const cells = rows[i].getElementsByTagName('td');
        const id = cells[1].textContent;
        
        if (id == userId) {
            const fullName = cells[3].textContent;
            const email = cells[4].textContent;
            
            document.getElementById('deleteUserName').textContent = fullName;
            document.getElementById('deleteUserEmail').textContent = email;
            
            // Set user ID in delete button data attribute
            document.getElementById('confirmDeleteButton').dataset.userId = userId;
            
            // Show the confirmation modal
            document.getElementById('deleteConfirmModal').style.display = 'block';
            break;
        }
    }
}