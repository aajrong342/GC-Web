<h1 class="notif-title">Notifications</h1>

{{#if notifications.length}}
  <!-- Notification List -->
    <ul class="notif-list">
        {{#each notifications}}
        <!-- Notification item -->
        <li class="notif-item {{#unless is_read}}unread{{/unless}}">
            <div class="notif-content">
              <h3 class="notif-type">{{uppercase message_type}}</h3>

              <!-- Toggle read/unread -->
              <button type="button"
                  class="mark-read-btn"
                  data-notif-id="{{id}}"
                  data-is-read="{{#if is_read}}true{{else}}false{{/if}}">
                {{#if is_read}}Mark as Unread{{else}}Mark as Read{{/if}}
              </button>
            </div>
            
            <p class="notif-message">{{{message}}}</p>

            <!-- Link button -->
            {{#if link}}
              <button type="button"
                class="link-btn"
                data-notif-id="{{id}}"
                data-is-read="{{#if is_read}}true{{else}}false{{/if}}"
                data-target-link="{{link}}">
                <i class="fa-solid fa-paperclip"></i> View Details
              </button>
            {{/if}}

            <span class="notif-date" datetime="{{created_at}}">{{created_at}}</span>
        </li>
        {{/each}}
    </ul>
{{else}}
    <p class="notif-empty">You have no notifications.</p>
{{/if}}

<!-- Time ago JS (for displaying relative time) -->
<script src="https://unpkg.com/timeago.js@4.0.2/dist/timeago.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    timeago.render(document.querySelectorAll('.notif-date'));
  });
</script>

<!-- Toggle read/unread + link button 'read' setting -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Mark as read
  document.querySelectorAll('.mark-read-btn').forEach(button => {
    button.addEventListener('click', async () => {
      const notifId = button.dataset.notifId;
      const isCurrentlyRead = button.dataset.isRead === 'true';
      const newIsRead = !isCurrentlyRead;

      console.log('Toggling notif:', notifId, 'New status:', newIsRead);

      try {
        const res = await fetch(`/notifications/toggle/${notifId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isRead: newIsRead })
        });

        if (!res.ok) throw new Error('Failed to toggle');

        button.dataset.isRead = String(newIsRead);
        button.textContent = newIsRead ? 'Mark as Unread' : 'Mark as Read';

        const item = button.closest('.notif-item');
        if (item) item.classList.toggle('unread', !newIsRead);

        // Update unread badge count
        const unreadCount = document.querySelectorAll('.notif-item.unread').length;
        const badge = document.getElementById('notif-badge');

        if (badge) {
          if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.style.display = 'inline-block';
          } else {
            badge.style.display = 'none';
          }
        }

      } catch (err) {
        console.error('Toggle error:', err);
        alert('Something went wrong.');
      }
    });
  });

  // Link button 'read' setting
  const linkButtons = document.querySelectorAll('.link-btn');

  linkButtons.forEach(button => {
    button.addEventListener('click', async () => {
      const notifId = button.dataset.notifId;
      const isRead = button.dataset.isRead === 'true';
      const target = button.dataset.targetLink;

      if (!isRead) {
        // Mark as read first
        try {
          await fetch(`/notifications/read/${notifId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ isRead: true })
          });

          // Optional: update badge count locally
          const item = button.closest('.notif-item');
          if (item) item.classList.remove('unread');

          const badge = document.getElementById('notif-badge');
          if (badge) {
            let newCount = document.querySelectorAll('.notif-item.unread').length;
            if (newCount > 0) {
              badge.textContent = newCount;
              badge.style.display = 'inline-block';
            } else {
              badge.style.display = 'none';
            }
          }

        } catch (err) {
          console.error('Failed to mark notification as read:', err);
        }
      }

      // Navigate regardless
      window.location.href = target;
    });
  });
});
</script>

<!-- Notif styles -->
<style>

.form-section {
  background-color: #fdfdfd;
  padding: 1.5rem;
  border-radius: 12px;
  border: 1px solid #ddd;
  margin: 1rem auto;
  font-family: 'Segoe UI', sans-serif;
  color: #333;
}

.notif-empty {
    font-size: large;
}

.notif-title {
  font-size: 1.8rem;
  margin-bottom: 1rem;
  font-weight: bold;
  color: #2f4858;
}

.notif-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.notif-item {
  background-color: #f8f9fa;
  border-left: 4px solid #ccc;
  padding: 1rem;
  margin-bottom: 1rem;
  border-radius: 6px;
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.notif-item.unread {
  border-left-color: #007bff;
  background-color: #e7f1ff;
}

.notif-type {
  margin: 0;
}

.notif-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

.notif-message {
  font-size: 1rem;
  margin-top: 5px;
  margin-bottom: 5px;
  color: #333;
  flex-grow: 1;
}

.notif-link {
  text-decoration: none;
  width: fit-content;
}

.mark-read-form {
  margin-top: 0.5rem;
}

.mark-read-btn {
  background-color: #289fa7;
  color: white;
  border: none;
  padding: 0.4rem 0.8rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
  width: fit-content;
}

.mark-read-btn:hover {
  background-color: #207e85;
}

.link-btn {
  background-color: #28a745;
  color: white;
  border: none;
  padding: 0.4rem 0.8rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
  width: fit-content;
}

.link-btn:hover {
  background-color: #218838;
}

.notif-read-label {
  color: #6c757d;
  font-size: 0.9rem;
}

.notif-date {
  font-size: 0.8rem;
  color: #676767;
  margin-left: auto;
}

</style>